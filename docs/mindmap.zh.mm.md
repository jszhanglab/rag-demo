# RAG 系统思维导图

## 产品目标
- 简洁易用
- 可审计 / 可追溯
- 可复现 / 可评测
- 合规与权限
- 成本可控 / 可扩展

## 前端 UI（M0）
- 首页 / 导航
- 上传页
  - 拖拽 / 选择文件
  - 文件类型/大小校验
  - 进度条 / 错误提示
- 聊天页
  - 问答区（Enter 发送 / Shift+Enter 换行）
  - **引用脚注** `[1][2]…`
  - 证据侧栏（标题 / 页码 / 评分 / 片段）
  - “无法回答”提示 + 最相近证据
- 文档预览
  - 页码跳转
  - chunk 高亮（`doc_id + page + chunk_id`）
- 审计控制台（M1）
  - 按 request_id / 用户 / 租户查询
  - 成本 & 延迟统计（7/30 天）
  - 导出 CSV

## 接入与解析（M0）
- /api/upload
- 病毒/类型校验（MIME / magic）
- PDF 文本解析（pdfminer / pdfplumber）
- OCR（PaddleOCR：图片页 / 日文竖排）
- 版面/表格解析（可选 M2）
- 元数据：文件名 / 页数 / SHA256 / 上传者

## 切块与索引（M0）
- 切块策略
  - 递归字符分割（500–800 tokens，overlap 50–100）
  - 标题/表格感知（可选 M2）
- Embedding
  - **可插拔模型**（`.env` 切换；自动记录版本）
  - 批/并行处理
- 向量库写入
  - upsert / 去重（按文档 SHA256）
  - 命名空间 & 租户隔离
- 元数据
  - `doc_id / page / chunk_id / offset` 持久化

## 检索与重排（M0）
- 检索器
  - 向量相似度 Top-K
  - 混合检索（BM25 + 向量，M1）
- 重排（M1）
  - Cross-encoder / bge-reranker
- 阈值与回退
  - 分数阈值：低于阈值 → “无法回答”
  - 熔断：仅返回证据模式

## 生成与**出处引用**（M0）
- 提示词模板：**必须带引用**（无引用→拒答/降级）
- 回答置信度：基于证据分布的启发式
- 引用结构（返回体）
  - `doc_id / page / chunk_id / score / snippet`
  - `confidence / policy_tag`
- UI 行为
  - 答案内脚注 `[1][2]`
  - 侧栏列表 + “在原文查看”跳转

## **内部审计 / 追踪**（M1）
- 表结构（Postgres）
  - `rag_request`：请求/状态/延迟/成本/错误
  - `rag_trace`：步骤/模型/版本/参数/tokens
  - `rag_evidence`：证据清单/分数/片段
- 日志策略
  - 只追加（append-only），关键字段不可更新
  - 可选：哈希链 / 签名防篡改（M2）
- 审计功能
  - 条件查询 / 明细回放 / CSV 导出
  - 脱敏查看（与 DLP 联动）

## 安全与合规（M1）
- 认证/鉴权
  - 多租户 / Workspace
  - 文档级 ACL
- DLP / PII
  - 上传与检索前扫描
  - 审计日志脱敏存储
- 加密与密钥
  - 静态加密（at-rest）/ 传输加密（in-transit）
  - KMS / 环境变量治理

## 工作流与治理（M2）
- 批量/增量索引
  - 文档更新差分重建
  - 去重（SHA256）
  - 失败重试 / 死信队列
- 自动化
  - 对象存储事件触发（R2/S3）
  - 索引完成通知
- 版本策略
  - 切块/检索/模型配置**签名化**记录

## 评测与 A/B（M1）
- 指标
  - 检索命中率@k
  - 引用准确率（引用-答案一致性）
  - 幻觉率（无证据生成）
  - P95 延迟 / 每问成本
- 工具
  - `evaluate.py` 评测脚本（CSV 输出）
  - 双链路 A/B（flag/env 切换）

## 监控与成本（M1）
- 贯通日志（request_id）
- Token / ms 成本聚合
- 趋势看板（7/30 天）
- 异常告警（成本暴涨 / 错误率 / P95）

## 存储层（M0）
- 对象存储（R2/S3）：原文 / 快照 / 预览
- 向量库：Chroma / Weaviate / Pinecone
- 关系型 DB：Postgres（元数据 / 审计 / 权限）

## 部署与工程（M0）
- Next.js（App Router + API Routes）
- 后端任务层：FastAPI / Serverless（可选）
- CI/CD（分支保护 / 预览环境）
- .env 管理（dev/stg/prod）
- 速率限制 / 幂等键 / 重试
- 文档：README / 架构图 / 一键启动脚本

## 路线图
- M0（最小闭环）
  - 上传 → 解析/OCR → 切块/索引 → 检索 → 生成 → **引用脚注 + 证据侧栏**
  - 向量库 + Postgres + R2/S3
  - 基础错误处理 / 速率限制 / README
- M1（专业化）
  - **内部审计三表** + 审计控制台
  - 评测与 A/B、混合检索、Reranker
  - 认证/鉴权、DLP/PII、加密与密钥
  - 监控与成本面板
- M2（进阶与治理）
  - 批量/增量索引、存储事件触发、任务队列
  - 版本签名、策略引擎（must_have_citation 等）
  - 版面/表格解析与结构化抽取、报告导出、复核流程
